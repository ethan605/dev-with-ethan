---
layout: post
title: "OAuth: Dùng Omniauth để đăng nhập với các dịch vụ phổ biến"
description: "Sử dụng gem Omniauth để đăng nhập vào các dịch vụ phổ biến: Facebook, Google+, Twitter"
date: 2016-07-13 11:00:00 +0700
categories: [misc]
tags: [oauth, 'xác thực', 'đăng nhập', google, facebook, twitter, ruby, omniauth]
comments: true
---

*... tiếp theo bài viết [OAuth: Các khái niệm cơ bản]({% post_url 2016-07-11-oauth-1 %})*

Chúng ta đã biết sử dụng OAuth có thể dùng để đăng nhập - xác thực và lấy thông tin từ những dịch vụ cung cấp OAuth. Trong bài này, tôi sẽ sử dụng **Ruby** và **Sinatra** cùng các gem **Omniauth** để thực hiện các thao tác.

# 1. Chuẩn bị #

Chúng ta sẽ tạo 1 thư mục `oauth-demo` chứa project của chúng ta, tạo các file `.ruby-version` `.ruby-gemset` và cài đặt `bundle` gem:

```shell
$ mkdir oauth-demo && cd "$_"
$ echo 2.2.4 > .ruby-version
$ echo oauth-demo > .ruby-gemset
$ cd .
ruby-2.2.4 - #gemset created /Users/ethan605/.rvm/gems/ruby-2.2.4@oauth-demo
ruby-2.2.4 - #generating oauth-demo wrappers - please wait
$ gem install bundle
$ bundle init
Writing new Gemfile to /Users/ethan605/Documents/Workspaces/Ruby/oauth-demo/Gemfile
```

Lúc này, `bundle` sẽ tạo ra 1 file tên là `Gemfile`, ta thêm vào file này 2 gem như sau:

```ruby
# frozen_string_literal: true
source "https://rubygems.org"

gem 'sinatra', '~> 1.4', '>= 1.4.7'
gem 'sinatra-reloader', '~> 1.0'
```

Rồi chạy lệnh `bundle` để cài đặt:

```shell
$ bundle
```

Mặc định **Sinatra** chỉ cần 1 file **Ruby** bất kỳ được cài đặt theo chuẩn. Tuy nhiên trong ví dụ này chúng ta sẽ sử dụng **Rack middleware** để quản lý các cài đặt 1 cách tập trung hơn.

Theo cách này, project của chúng ta cần 3 file: `config.ru`, `secrets.yml` & `app.rb`:

```ruby
# config.ru
require 'bundler/setup'
require 'sinatra/config_file'
require 'omniauth-facebook'
require './app.rb'

config_file './secrets.yml'

use Rack::Session::Cookie, secret: settings.cookies["secret"]

use OmniAuth::Builder do
  # For multiple strategies configs
end

run Sinatra::Application
```

```yaml
# secrets.yml
cookies:
  secret: "oauth-demo@dev.ethanify.me"
```

```ruby
# app.rb
require 'sinatra'
require 'sinatra/reloader'

# configure sinatra
set :run, false
set :raise_errors, true

get '/login/:provider' do
  # For OAuth login requests
end

get '/auth/:provider/callback' do
  # For OAuth login callbacks
end
```

Trong đó, mỗi file có 1 nhiệm vụ:

* `config.ru`: chứa toàn bộ cài đặt của project **Sinatra** để đảm bảo chạy đúng
* `secrets.yml`: chứa các thông tin quan trọng và nhạy cảm (Secret của Cookies, App ID, App Secret của các dịch vụ mạng xã hội cung cấp đăng nhập & xác thực bằng OAuth)
* `app.rb`: chứa các xử lý logic đối với từng request từ phía client, trong ví dụ này chúng ta có 2 request:
  * `GET` đến đường dẫn `/login/oauth`, ở đây `:provider` có thể là `facebook`, `google`, `twitter`,..., dùng để hiện ra 1 trang web, nơi mà người dùng có thể đăng nhập bằng **Facebook**, **Google+** hay **Twitter**,...
  * `GET` đến đường dẫn `/auth/:provider/callback`, đây là đường dẫn sẽ được xử lý tự động bằng **Omniauth**.

Cuối cùng, ta tiến hành chạy server bằng lệnh `rackup` tại thư mục có chứa file `config.ru`:

```shell
$ rackup
loading config file './secrets.yml'
[2016-07-13 15:54:40] INFO  WEBrick 1.3.1
[2016-07-13 15:54:40] INFO  ruby 2.2.4 (2015-12-16) [x86_64-darwin15]
[2016-07-13 15:54:40] INFO  WEBrick::HTTPServer#start: pid=5925 port=9292
```

Lúc này, server của chúng ta sẽ nhận các request thông qua địa chỉ `http://localhost:9292`.

# 2. Đăng nhập với Facebook #

## 2.1. Cài đặt Facebook ##

Đối với tất cả các dịch vụ cung cấp **OAuth** hiện nay, chúng ta đều cần phải đăng ký trở thành **developer** và đăng ký ứng dụng (gọi là **app**) với các dịch vụ này. Đối với **Facebook**, chúng ta thực hiện đăng ký qua trang **developers.facebook.com**.

Sau khi tạo mới 1 ứng dụng, tại **Dashboard**, các bạn click vào **+ Add Product** ở panel bên tay trái như trong hình dưới đây:

![Facebook Settings - Add Product][fb-settings-1]
{:style="text-align: center"}

Trong màn hình **Product Setup**, ta chọn **Get Started** tại mục **Facebook Login**:

![Facebook Settings - Facebook Login - Get Started][fb-settings-2]
{:style="text-align: center"}

Tại phần **Valid OAuth redirect URIs** ta đặt giá trị `localhost:9292/auth/facebook/callback`:

![Facebook Settings - Facebook Login - Valid OAuth redirect URIs][fb-settings-3]
{:style="text-align: center"}

Các cài đặt này đảm bảo **Facebook** nhận diện đúng **OAuth** từ server của chúng ta, tránh trường hợp nhận diện nhầm các server khác, từ đó có thể bị tấn công và ăn cắp dữ liệu người dùng.

## 2.2. Cài đặt server OAuth Demo ##

Quay lại với project **OAuth Demo**, tại file `secrets.yml`, ta đặt các giá trị **App ID** và **App Secret** lấy từ trang **Dashboard** của **Facebook**:

![Facebook Settings - App ID & App Secret][fb-settings-4]

```yaml
# secrets.yml
facebook:
  app_id: "1058494070XXXXXX"
  app_secret: "27e352595e6effa0db8d44870dXXXXXX"
```



# 3. Đăng nhập với Google+ #

# 4. Đăng nhập với Twitter #

[fb-settings-1]:    /assets/media/posts/misc/2016-07-13-facebook-settings-1.png
[fb-settings-2]:    /assets/media/posts/misc/2016-07-13-facebook-settings-2.png
[fb-settings-3]:    /assets/media/posts/misc/2016-07-13-facebook-settings-3.png
[fb-settings-4]:    /assets/media/posts/misc/2016-07-13-facebook-settings-4.png